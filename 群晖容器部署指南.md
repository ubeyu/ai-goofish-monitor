# 群晖Container定时任务部署指南

## 一、环境准备

### 1.1 更新群晖系统和Container Manager
确保您的群晖系统和Container Manager已更新到最新版本，以获得最佳的兼容性和稳定性。

### 1.2 创建必要的目录结构
在群晖的文件系统中创建以下目录：
- `/docker/ai-goofish/images` - 存储下载的商品图片
- `/docker/ai-goofish/logs` - 应用日志
- `/docker/ai-goofish/jsonl` - 数据文件
- `/docker/ai-goofish/state` - 应用状态
- `/docker/ai-goofish/prompts` - 提示词模板

## 二、容器创建与配置

### 2.1 镜像拉取
可以通过两种方式获取镜像：

**方式1：从Docker Hub拉取（推荐）**
```bash
docker pull ubeyu/ai-goofish-monitor:latest
```

**方式2：本地构建**
```bash
# 克隆代码仓库
git clone https://github.com/ubeyu/ai-goofish-monitor.git
cd ai-goofish-monitor
# 构建镜像
docker build -t ai-goofish-monitor .
```

### 2.2 Container Manager配置

1. **打开群晖Container Manager**
2. **点击"创建"**
3. **选择"使用已有的镜像"**

#### 2.2.1 基本设置
- **镜像名称**：ubeyu/ai-goofish-monitor:latest
- **容器名称**：ai-goofish-monitor
- **高级设置**：勾选

#### 2.2.2 网络设置
- **网络**：默认使用"bridge"网络
- **端口设置**：
  - 本地端口：8000
  - 容器端口：8000

#### 2.2.3 存储空间
**添加文件夹映射**：
| 本地文件夹 | 容器文件夹 | 权限 |
|----------|-----------|------|
| `/docker/ai-goofish/images` | `/app/images` | 读写 |
| `/docker/ai-goofish/logs` | `/app/logs` | 读写 |
| `/docker/ai-goofish/jsonl` | `/app/jsonl` | 读写 |
| `/docker/ai-goofish/state` | `/app/state` | 读写 |
| `/docker/ai-goofish/prompts` | `/app/prompts` | 读写 |

#### 2.2.4 环境变量
添加以下环境变量：
| 变量名 | 值 | 说明 |
|-------|-----|------|
| `RUNNING_IN_DOCKER` | `true` | 标记为Docker环境 |
| `TZ` | `Asia/Shanghai` | 时区设置 |
| `SERVER_PORT` | `8000` | 服务端口 |
| `PYTHONUNBUFFERED` | `1` | 实时输出日志 |

#### 2.2.5 资源限制
根据您的群晖硬件配置设置合理的资源限制：
- **CPU限制**：建议至少2核心
- **内存限制**：建议至少2GB

#### 2.2.6 高级设置
- **执行命令**：保持默认（无需修改）
- **容器开机自启**：勾选

## 三、定时任务调试

### 3.1 查看容器日志
```bash
docker logs -f ai-goofish-monitor
```

### 3.2 关键日志分析

#### 3.2.1 启动日志
```
[调度器初始化] RUNNING_IN_DOCKER: true
[调度器初始化] TZ环境变量: Asia/Shanghai
[调度器初始化] 当前时间: 2026-01-18 13:27:01 中国标准时间+0800
[调度器初始化] 创建调度器，时区: Asia/Shanghai
[网络检查] 正在检查网络连通性...
[网络检查] ✓ 成功连接到 www.taobao.com:443
[网络检查] ✓ 成功连接到 www.baidu.com:443
[网络检查] ✓ 成功连接到 ntfy.sh:443
[网络检查] ✓ DNS解析正常
正在重新加载定时任务...
  -> 已移除所有现有定时任务
  -> 共发现 2 个已启用的定时任务
  -> 处理任务 1/2: '测试任务'
     [调试] 解析为6字段Cron表达式: 秒=*/10, 分=*, 时=*, 日=*, 月=*, 周=*
     ✓ 已为任务 '测试任务' 添加定时规则: '*/10 * * * * *'
  -> 处理任务 2/2: '监控任务'
     [调试] 解析为5字段Cron表达式: 0 */1 * * *
     ✓ 已为任务 '监控任务' 添加定时规则: '0 */1 * * *'
  -> 成功加载 2 个定时任务
     - Scheduled: 测试任务 (ID: task_1, 下次执行: 2026-01-18 13:27:10+08:00)
     - Scheduled: 监控任务 (ID: task_2, 下次执行: 2026-01-18 14:00:00+08:00)
调度器已启动
应用启动完成
```

#### 3.2.2 任务执行日志
```
[调度器事件] 2026-01-18 13:27:10 - 作业执行 作业ID: task_1, 作业名称: Scheduled: 测试任务
[任务执行] 定时任务触发: 正在为任务 '测试任务' (ID: 1) 启动爬虫...
[任务执行] 任务 '测试任务' (ID: 1) 执行完成
[调度器事件] 2026-01-18 13:27:15 - 作业执行成功 作业ID: task_1, 作业名称: Scheduled: 测试任务
```

### 3.3 常见问题排查

#### 3.3.1 定时任务不执行

**可能原因1：时区问题**
- 检查容器日志中的"当前时间"是否正确
- 确保群晖系统时区和容器时区一致

**可能原因2：网络问题**
- 检查网络连通性日志
- 确保群晖可以访问互联网
- 检查是否有防火墙规则阻止了连接

**可能原因3：权限问题**
- 确保映射的卷有正确的读写权限
- 检查容器内文件权限：
  ```bash
  docker exec -it ai-goofish-monitor ls -la /app
  ```

**可能原因4：任务配置错误**
- 检查Cron表达式是否正确
- 确保任务已启用

#### 3.3.2 任务执行失败

**查看详细错误日志**：
```bash
docker logs -f ai-goofish-monitor | grep -A 20 "[任务执行] 错误"
```

**常见错误及解决方案**：
- **网络连接失败**：检查网络配置和防火墙规则
- **文件权限错误**：重新设置卷的权限
- **资源不足**：增加容器的CPU和内存限制
- **依赖缺失**：确保镜像已正确构建

## 四、高级调试技巧

### 4.1 进入容器内部
```bash
docker exec -it ai-goofish-monitor bash
```

### 4.2 手动执行测试脚本
```bash
# 在容器内执行
python -m test_scheduler
```

### 4.3 检查调度器状态
```bash
docker exec -it ai-goofish-monitor python -c "
from src.services.scheduler_service import scheduler_service
jobs = scheduler_service.scheduler.get_jobs()
for job in jobs:
    print(f'作业: {job.name}, ID: {job.id}, 下次执行: {job.next_run_time}')
"
```

### 4.4 重启调度器
```bash
docker restart ai-goofish-monitor
```

## 五、最佳实践

### 5.1 定期备份
- 定期备份映射的卷目录
- 特别是`/docker/ai-goofish/state`和`/docker/ai-goofish/logs`目录

### 5.2 监控系统资源
- 定期检查群晖的CPU、内存和磁盘使用情况
- 根据需要调整容器的资源限制

### 5.3 保持镜像更新
- 定期更新容器镜像以获取最新功能和bug修复

### 5.4 使用固定端口
- 在群晖中使用固定的本地端口映射，避免端口冲突

## 六、联系支持

如果您遇到无法解决的问题，可以通过以下方式获取支持：

- **GitHub Issues**：https://github.com/ubeyu/ai-goofish-monitor/issues
- **Discord社区**：https://discord.gg/yourcommunity
- **微信群**：扫描项目README中的二维码

## 七、版本更新

当有新版本发布时，您可以按照以下步骤更新：

1. 停止并删除旧容器
2. 拉取新镜像
3. 使用相同的配置创建新容器
4. 验证新容器的运行状态

---

**注意**：以上指南基于群晖DSM 7.2和Container Manager 3.1版本编写，不同版本的界面可能会有所不同。如果您使用的是旧版本，请参考群晖官方文档进行相应调整。